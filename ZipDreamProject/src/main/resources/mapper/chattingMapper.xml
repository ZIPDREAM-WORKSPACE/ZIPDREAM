<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="chattingMapper">
	
	<resultMap type="chatRoom" id="chatRoomResultSet">
		<result property="chatRoomNo" column="CHAT_ROOM_NO"/>
		<result property="title" column="TITLE"/>
		<result property="userNo" column="USER_NO"/>
		<result property="status" column="STATUS"/>
		
	</resultMap>
	
	<resultMap type="chatMessage" id="chatMessageResultSet">
		<result column="CM_NO" property="cmNo" />
		<result column="MESSAGE" property="message" />
		<result column="CREATE_DATE" property="createDate" />
		<result column="CHAT_ROOM_NO" property="chatRoomNo" />
		<result column="USER_NO" property="userNo" />
	</resultMap>
	
	<select id="selectChatRoomList" resultMap="chatRoomResultSet">
		SELECT 
			CHAT_ROOM_NO,
			TITLE,
			(SELECT COUNT(*) FROM CHAT_ROOM_JOIN B WHERE B.CHAT_ROOM_NO = A.CHAT_ROOM_NO) CNT
		FROM CHAT_ROOM A
		JOIN MEMBER M USING(USER_NO)
		WHERE A.STATUS = 'Y'
		ORDER BY CHAT_ROOM_NO DESC
	</select>
	
	<insert id="openChatRoom" useGeneratedKeys="true" keyProperty="chatRoomNo" >
		<!-- <selectKey keyProperty="chatRoomNo" resultType="int" order="BEFORE">
			SELECT 	CHAT_ROOM_NO.NEXTVAL FROM DUAL
		</selectKey> -->
		
		INSERT INTO CHAT_ROOM VALUES
		(#{chatRoomNo}, #{refUno},  #{status}, #{title})
	</insert>
	
	<!-- 채팅방 참여 여부 확인 -->
	
	<select id="joinCheck" resultType="_int" parameterType="chatRoomJoin">
		SELECT COUNT(*)
		FROM CHAT_ROOM_JOIN
		WHERE CHAT_ROOM_NO = #{chatRoomNo}
		AND REF_UNO = #{refUno}
	</select>
	
	<!-- 채팅방 참여하기 -->
	<insert id="joinChatRoom" parameterType="chatRoomJoin">
		INSERT INTO CHAT_ROOM_JOIN
		VALUES (#{chatRoomNo},#{refUno} )
	</insert>
	
	<!-- 채팅 메세지 목록 조회 -->
	<select id="selectChatMessage" resultMap="chatMessageResultSet">
		SELECT
			MESSAGE,
			CREATE_DATE,
			USER_NO,
		FROM CHAT_MESSAGE
		JOIN MEMBER USING(USER_NO)
		WHERE CHAT_ROOM_NO = #{chatRoomNo}
		ORDER BY CM_NO
	</select>
	
	<!-- 채팅메세지 삽입 -->
	<insert id="insertMessage" parameterType="chatMessage" useGeneratedKeys="true" keyProperty="cmNo" >
		INSERT INTO CHAT_MESSAGE(CHAT_ROOM_NO,REF_UNO,MESSAGE,CREATE_DATETIME)
		VALUES(#{chatRoomNo},#{refUno},#{message}, SYSDATE() )
	</insert>
	
	
	<!-- 채팅방 나가기 -->
	<delete id="exitChatRoom" parameterType="chatRoomJoin">
		DELETE FROM CHAT_ROOM_JOIN
		WHERE USER_NO = #{userNo} 
		AND CHAT_ROOM_NO = #{chatRoomNo}  
	</delete>
<!-- 	
	채팅방 인원 수 확인
	<select id="countChatRoomMember" resultType="_int">
		SELECT
			COUNT(*)
		FROM CHAT_ROOM_JOIN
		WHERE CHAT_ROOM_NO = #{chatRoomNo}
	</select> -->
	
	<!-- 채팅방 닫기 -->
	<update id="closeChatRoom">
		UPDATE CHAT_ROOM SET
		STATUS = 'N'
		WHERE CHAT_ROOM_NO = #{chatRoomNo}
	</update>
</mapper>
